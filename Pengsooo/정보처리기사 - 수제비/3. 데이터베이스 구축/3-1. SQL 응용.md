# Ⅲ.  데이터베이스 구축



## Ch1. SQL 응용

### (1) 절차형 SQL 작성

#### 1. 트리거

**트리거**는 시스템에서 삽입, 갱신, 삭제 등의 이벤트가 발생할 때마다 관련 작업이 자동으로 수행되는 절차형  SQL이다. <span style="color:blue">*V*</span>



- 목적

  - 일반적으로 이벤트와 관련된 테이블의 데이터 삽입, 추가, 삭제 작업을 DBMS가 자동적으로 실행시키는 데 활용.

  - 데이터 무결성 유지 및 로그 메시지 출력 등의 별도 처리를 위해 사용되기도 함.

    

- 구성

  |        구성요소        | 설명                                                         |
  | :--------------------: | :----------------------------------------------------------- |
  |    선언부(DECLARE)     | 변수 및 상수, 타입 선언                                      |
  |    이벤트부(EVENT)     | 트리거가 실행되는 이벤트 명시                                |
  | 시작/종료부(BEGIN/END) | 트리거의 시작과 종료를 표현하는데 필수적<br />BEGIN/END가 쌍을 이루어 추가되므로 블록으로 구성<br />다수 실행을 제어하는 기본적 단위가 되며 논리적 프로세스를 구성 |
  |    제어부(CONTROL)     | 제어 단위 블록별 실행 흐름을 제어<br />비교 조건에 따라 블록 또는 문장을 실행 |
  |          SQL           | 데이터 관리를 위한 조회, 추가, 수정, 삭제<br />DML을 주로 사용하고, 가끔 DDL을 사용 |
  |   예외부(EXCEPTION)    | 실행 중 발생 가능한 예외 상황 수행                           |

  

- 예시

  ```sql
  CREATE TRIGGER T_STUDENT
  BEFORE INSERT ON STUDENT
  BEGIN
  	IF (AGE < 19) THEN
  		RAISE_APPLICATION_ERROR
  			(-20502, '미성년자 삽입 불가');
  	END IF;
  END;
  ```
  
  1. T_STUDENT라는 트리거 명 선언.
  
  2. 조건 문장이 실행되기 전(BEFORE)에 트리거의 내용이 실행되고, 삽입(INSERT)시에 발생.
  
  3. STUDENT 테이블에 AGE가 19미만인 값이 삽입될 경우 20502번 에러 발생.
  
     
  
- 작성 시 주의사항

  - TCL 사용 불가: 트리거 내에는 TCL(트랜잭션 제어어) 사용 시 컴파일 에러 발생.
  - 오류에 주의: 트리거 실행 중 발생한 오류는 트리거 실행의 원인을 제공한 데이터 작업에도 영향을 줌.



#### 2. 이벤트

**이벤트**는 시간에 특정한 쿼리, 프로시저, 함수 등을 실행시키는 기능이다.



- 구문 요소
  
  - 이벤트명: 해당 이벤트를 호출할 때 사용할 이름을 지정.
  - 스케줄: 이벤트의 실행시간과 간격을 지정.
  
  
  
- 예시

  

  

  ```SQL
  CREATE EVENT T_TEST
  	ON SCHEDULE
  		EVERY 50 SECOND
  	DO INSERT INTO TEST
  			SET REGDATE=NOW();
  ```

  1. T_TEST라는 이름의 이벤트 실행.
  2. EVERY 50 SECOND: 50초에 한 번씩 실행.
  3. TEST라는 테이블에 현재 시간으로부터 50초마다 INSERT를 실행.



#### 3. 사용자 정의함수

**사용자 정의함수**는 절차형 sql을 활용하여 일련의 연산 처리 결과를 단일 값으로 반환할 수 있는 함수이다.



- 특징
  
  - 일반적으로 호출을 통해 실행.
  - 반환되는 단일 값을 조회 또는 삽입, 수정 작업에 이용.
  - 프로시저와의 가장 큰 차이점: 종료 시 단일 값을 반환함.
  
  
  
- 구성

|        구성요소        | 설명                                                         |
| :--------------------: | :----------------------------------------------------------- |
|    선언부(DECLARE)     | 변수 및 상수, 타입 선언                                      |
| 시작/종료부(BEGIN/END) | 트리거의 시작과 종료를 표현하는데 필수적<br />BEGIN/END가 쌍을 이루어 추가되므로 블록으로 구성<br />다수 실행을 제어하는 기본적 단위가 되며 논리적 프로세스를 구성 |
|    제어부(CONTROL)     | 제어 단위 블록별 실행 흐름을 제어<br />비교 조건에 따라 블록 또는 문장을 실행 |
|          SQL           | 데이터 관리를 위한 조회, 추가, 수정, 삭제<br />조회 용도로 SELCET 문을 사용<br />데이터를 조작하는 INSERT, DELETE, UPDATE는 사용할 수 없음 |
|   예외부(EXCEPTION)    | 실행 중 발생 가능한 예외 상황 수행                           |
|     반환부(RETURN)     | 호출문에 대한 함수 값을 반환                                 |



- 예시

  ```SQL
  CREATE FUNCTION GET_AGE
      (V_BIRTH_YEAR IN CHAR(4))
  IS
    V_THIS_YEAR CHAR(4);
  BEGIN
      SELECT TO_CHAR(SYSDATE, 'YYYY')
      	INTO V_THIS_YEAR
      	FROM DUAL;
  
  	  	RETURN V_THIS_YEAR
  	  		- V_BIRTH_YEAR + 1;
  END;
  ```

  1. GET_AGE라는 이름의 함수 선언.
  2. V_THIS_YEAR이라는 CHAR(4) 변수 생성.
  3. SYSDATE(현재 시간)을 'YYYY'(4자리 연도)로 받음.
  4. V_THIS_YEAR라는 변수에 삽입.
  5. 현재 연도와 생년을 숫자 형식으로 변환한 후 두 수의 차에 1을 더한 값(나이)을 반환.

  

- 사용자 정의함수 호출쿼리 작성
  
  - 사용자 정의함수는 프로시저와 동일하게 외부에서의 호출을 통해 실행.
  - 타 시스템에 정보 제공 등 은닉을 통해 캡슐화를 제공하는 데에 많이 사용함.
  - DML(데이터 조작어) 문장을 활용하여 사용자 정의 함수를 호출.



#### 4. SQL 문법

**SQL(Structured Query Language) 문법**은 데이터베이스를 접근하고 조작하는 데 필요한 표준 언어를 활용할 수 있게 해주는 규칙이다.



- 분류

  | 분류               | 설명                                                         |
  | ------------------ | ------------------------------------------------------------ |
  | 데이터 정의어(DDL) | 데이터를 정의하는 언어<br />테이블이나 관계의 구조를 생성하는 데 사용<br />CREATE, ALTER, DROP, TRUNCATE |
  | 데이터 조작어(DML) | 데이터베이스에 저장된 자료들을 입력, 수정, 삭제, 조회하는 언어<br />SELECT, INSERT, UPDATE, DELETE |
  | 데이터 제어어(DCL) | 데이터베이스 관리자가 데이터 보안, 무결성 유지, 병행 제어, 회복을 위해 DBA가 사용하는 제어용 언어<br />GRANT, REVOKE |

  

- WHERE 조건

  |   구분   | 연산자                                                       |
  | :------: | ------------------------------------------------------------ |
  |   비교   | =, <>, <, <=, >, >=                                          |
  |   범위   | BETWEEN <span style="color:blue">*V*</span><span style="color:blue">*V*</span> |
  |   집합   | IN, NOT IN                                                   |
  |   패턴   | LIKE <span style="color:blue">*V*</span>                     |
  |   NULL   | IS NULL, IS NOT NULL <span style="color:blue">*V*</span><span style="color:blue">*V*</span> |
  | 복합조건 | AND, OR, NOT                                                 |

  - EX. 50 이상 100 이하인 점수

    ```SQL
    SCORE BETWEEN 50 AND 100
    ```

    

- LIKE와 같이 사용하는 와일드 문자

  | 와일드 문자 | 설명                          |
  | :---------: | ----------------------------- |
  |      +      | 문자열을 연결                 |
  |      %      | 0개 이상의 문자열과 일치      |
  |     []      | 1개의 문자와 일치             |
  |     [^]     | 1개의 문자와 불일치           |
  |      _      | 특정 위치의 1개의 문자와 일치 |

  

- 주석 처리

  데이터 베이스에 대한 설명을 작성하거나 특정 SQL 실행을 하지 않도록 하기 위해 사용.

  |  주석 기호   | 설명                                                         |
  | :----------: | ------------------------------------------------------------ |
  |      --      | '--'이 시작하는 위치부터 해당 라인 끝까지 실행이 되지 않도록 함 |
  | /\* 문장 \*/ | '/\*' 시작되는 부분부터 '\*/'이 나타날 때까지 여러 라인에 걸쳐 실행이 되지 않도록 함 |

  

- 힌트 사용

  SQL 힌트란 실행하려 하는 SQL문에 사전에 정보를 주어서 SQL문 실행에 빠른 결과를 가져오는 효과를 만드는 문법. 주석에 '+' 기호를 붙이면 힌트로 인식.

  | 힌트                            | 설명                                               |
  | ------------------------------- | -------------------------------------------------- |
  | --+ 힌트 명(파라미터, ...)      | '--+'이 시작되는 위치부터는 힌트로 인식            |
  | /\*+ 힌트 명(파라미터, ...) \*/ | '/\*+'이 시작되는 부분부터 '\*/'사이를 힌트로 인식 |

  - EX. 테이블에 인덱스가 실행되도록 힌트 작성
  
    ```SQL
    SELECT /*+ INDEX(STUDENT IX_STUDENT) */
    	FROM STUDENT
    	WHERE NAME='김철수';
    ```





### (2) 응용 SQL 작성

#### 1. 데이터 조작어(DML)

**데이터 조작어(Data Manipulation Language)** 는 데이터베이스에 저장된 자료들을 입력, 수정, 삭제, 조회하는 언어이다.



- 유형

  |  유형  |    동작     | 설명                                                         |
  | :----: | :---------: | ------------------------------------------------------------ |
  | SELECT | 데이터 조회 | 해당 테이블을 구성하는 튜플 중에서 전체 또는 조건을 만족하는 튜플을 검색하여\|<br />주기억장치 상에 임시 테이블로 구성하는 명령문 |
  | INSERT | 데이터 생성 | 해당 테이블에 새로운 튜플을 삽입할 때 사용하는 명령문        |
  | UPDATE | 데이터 변경 | 해당 테이블에 있는 튜플 중에서 특정 튜플의 내용을 변경할 때 사용하는 명령문 |
  | DELETE | 데이터 삭제 | 해당 테이블에 있는 튜플 중에서 특정 튜플을 삭제할 때 사용하는 명령문 |

  

- 명령어

  - SELECT

    데이터의 내용을 조회할 때 사용하는 명령어.

    ```sql
    SELECT [ALL | DISTINCT | DISTINCTROW] 속성명1, 속성명2, ...
    	FROM 테이블명1, ...
    WHERE 조건
    GROUP BY 속성명1, ...
    HAVING 그룹조건
    ORDER BY 속성 [ASC | DESC];
    ```

    |    구분     | 설명                                                         |
    | :---------: | ------------------------------------------------------------ |
    |  SELECT 절  | 검색하고자 하는 속성명, 계산식<br />2개 이상의 테이블을 대상으로 검색할 때는 '테이블명, 속성명'으로 표현<br />ALL: 모든 튜플을 검색할 때 사용. Default 값.<br />DSITINCT: 중복된 속성이 조회될 경우 그 중 첫 번째 한 개만 검색.<br />DISTINCTROW: SELECT 뒤에 속성들과 상관없이 튜플 전체가 중복된 튜플을 제거. |
    |   FROM 절   | 질의에 의해 검색될 데이터들을 포함하는 테이블명을 기술       |
    |  WHERE 절   | 검색할 조건을 기술                                           |
    | GROUP BY 절 | 속성값을 그룹으로 분류하고자 할 때 사용                      |
    |  HAVING 절  | GROUP BY에 의해 분류한 후 그룹에 대한 조건을 기술            |
    | ORDER BY 절 | 속성값을 정렬하고자 할 때 사용<br />ASC는 오름차순 정렬, DESC는 내림차순 정렬 |

    - EX. [학생] 테이블에서 학년이 6학년이고, 수강과목이 '음악'인 학생의 성명과 연락처 검색.

      ```SQL
      SELECT 성명, 연락처 FROM 학생 WHERE 학년 = 6 AND 수강과목 = '음악';
      ```

  - INSERT

    데이터의 내용을 삽입할 때 사용하는 명령어.

    | 구문                                                         | 설명                                                         |
    | ------------------------------------------------------------ | ------------------------------------------------------------ |
    | INSERT INTO 테이블명(속성명1, ...)<br />VALUES(데이터1, ...) | 속성과 데이터 개수, 데이터 타입이 일치해야 함<br />속성명은 생략 가능 |

    - EX. [학생] 테이블에 학번이 6677, 성명 '장길산', 학년이 3학년, 수강과목은 '수학'인 학생을 삽입.

      ```SQL
      INSERT INTO 학생(학번, 성명, 학년, 수강과목)
      VALUES(6677, '장길산', 3, '수학');
      ```

  - UPDATE

    데이터의 내용을 변경할 때 사용하는 명령어.

    | 구문                                                         | 설명                                                         |
    | ------------------------------------------------------------ | ------------------------------------------------------------ |
    | UPDATE 테이블명<br />SET 속성명 = 데이터, ...<br />WHERE 조건; | UPDATE 명령문은 WHERE 절을 통해 어떤 조건이 만족할 경우에만<br />특정 컬럼의 값을 수정하는 용도로 자주 사용됨. |

    - EX. [학생] 테이블에 장길산의 주소를 인천으로 수정

      ```SQL
      UPDATE 학생
      	SET 주소 = '인천'
      	WHERE 이름 = '장길산';
      ```

  - DELETE

    데이터의 내용을 삭제할 때 사용하는 명령어.

    | 구문                                   | 설명                                                         |
    | -------------------------------------- | ------------------------------------------------------------ |
    | DELETE FROM 테이블명<br /> WHERE 조건; | 모든 레코드를 삭제할 때는 WHERE절 없이 DELETE만 사용<br />레코드를 삭제해도 테이블 구조는 남아 있음(DROP과 다른 점) |

    - EX. [학생] 테이블에 장길산에 대한 튜플을 삭제

      ```SQL
      DELETE FROM 학생
      WHERE 이름 = '장길산';
      ```



#### 2. 데이터 제어어(DCL)

**데이터 제어어(Data Control Language)** 는 DB 관리자가 데이터 보안, 무결성 유지, 병행 제어, 회복을 위해 사용하는 언어.



- 기능

  |     기능      | 설명                                                         |
  | :-----------: | ------------------------------------------------------------ |
  |  데이터 보안  | 불법적인 사용으로부터 데이터를 보호하는 기능                 |
  |  무결성 유지  | 데이터의 정확성과 일관성을 유지하는 기능                     |
  | 병행수행 제어 | 여러 트랜잭션을 수행할 때 트랜잭션들이 데이터베이스의 일관성을 파괴하지 않도록<br />트랜잭션 간의 상호작용을 제어하는 기능 |
  |     회복      | 데이터베이스 장애가 발생한 경우, 데이터베이스를 장애 발생 이전의 상태로 복원하는 기능 |

  

- 유형

  COMMIT, ROLLBACK, SAVEPOINT는 TCL(Transaction Control Language)라고도 불린다.

  |            명령어            |      동작      | 설명                                                         |
  | :--------------------------: | :------------: | ------------------------------------------------------------ |
  |            GRANT             | 사용 권한 부여 | 관리자가 사용자에게 데이터베이스에 대한 권한을 부여하는 명령어 |
  |            REVOKE            | 사용 권한 취소 | 관리자가 사용자에게 부여했던 권한을 회수하기 위한 명령어     |
  |            COMMIT            | 트랜잭션 확정  | 데이터베이스 트랜잭션의 내용 업데이트를 영구적으로 확정하는 명령어 |
  |           ROLLBACK           | 트랜잭션 취소  | 데이터베이스에서 업데이트 오류가 발생할 때, 이전 상태로 되돌리는 명령어 |
  | SAVEPOINT<br />(=CHECKPOINT) | 저장 시기 설정 | 트랜잭션의 특정 지점에 이름을 지정하고, 그 지점 이후에 수행한 작업을 롤백할 수 있는 명령어 |

  

- 명령어

  - GRANT

    데이터베이스 관리자가 사용자에게 데이터베이스에 대한 권한을 부여하는 명령어.

    |    권한     |              구문               | 설명                                                         |
    | :---------: | :-----------------------------: | ------------------------------------------------------------ |
    | 시스템 권한 |      GRANT 권한 TO 사용자;      | 관리자가 사용자에게 테이블/뷰/프로시저 등을 생성/삭제할 수 있는 권한을 부여 |
    |  객체 권한  | GRANT 권한 ON 테이블 TO 사용자; | 관리자가 사용자에게 테이블을 수정, 삽입, 삭제, 조회와 프로시저 실행을 할 수 있는<br />권한을 부여 |
    
    - GRANT 구문 마지막에 WITH GRANT OPTION 키워드를 붙이면 다른 사용자에게 부여할 수 있는 권한을 부여할 수 있다.
    
    - EX. 관리자가 사용자인 '장길산'에게 '학생' 테이블에 대해 수정(UPDATE)할 수 있는 권한을 부여.
    
      ```SQL
      GRANT UPDATE ON 학생 TO 장길산;
      ```
    
    - EX. 관리자가 사용자 '장길산'에게 '학생' 테이블에 대해 조회(SELECT)할 수 있는 권한과 그 권한을 다른 사용자에게 부여할 수 있는 권한 부여.
    
      ```SQL
      GRANTE SELECT ON 학생 TO 장길산 WITH GRANT OPTION;
      ```
    
  - REVOKE
  
    데이터베이스 관리자가 사용자에게 부여했던 권한을 회수하기 위한 명령어.
  
    |    권한     |                구문                | 설명                                                         |
    | :---------: | :--------------------------------: | ------------------------------------------------------------ |
    | 시스템 권한 |      REVOKE 권한 FROM 사용자;      | 관리자가 사용자에게 테이블/뷰/프로시저 등을 생성/삭제할 수 있는 권한을 회수 |
    |  객체 권한  | REVOKE 권한 ON 테이블 FROM 사용자; | 관리자가 사용자에게 테이블을 수정, 삽입, 삭제, 조회와<br />프로시저 실행을 할 수 있는 권한을 회수 |
  
    - REVOKE 구문 마지막에 CASCADE CONSTRAINTS 키워드를 붙이면 WITH GRANTE OPTION으로 부여된 사용자들의 권한까지 회수한다.
  
    - EX. 관리자가 사용자인 '장길산'에게 '학생' 테이블에 대해 수정(UPDATE)할 수 있는 권한을 회수.
  
      ```SQL
      REVOKE UPDATE ON 학생 FROM 장길산
      ```
  
    - EX. 관리자가 사용자인 '장길산'에게 '학생' 테이블에 대해 조회(SELECT)할 수 있는 권한과 WITH GRANTE OPTION으로 부여된 사용자들의 권한까지 회수.
  
      ```SQL
      REVOKE SELECT ON 학생 FROM 장길산 CASCADE CONSTRAINT;
      ```
  
  - TCL
  
    트랜잭션을 제어하는 언어.
  
    |       명령문       |            구문             | 설명                                                  |
    | :----------------: | :-------------------------: | ----------------------------------------------------- |
    |   트랜잭션 확정    |           COMMIT;           | 데이터베이스 트랜잭션 내용 업데이트를 영구적으로 확정 |
    |   트랜잭션 취소    |          ROLLBACK;          | 데이터베이스 업데이트 오류 발생 시 이전 상태로 되돌림 |
    | 세이브 포인트 지정 |       SAVEPOINT 이름;       | 특정 지점을 지정                                      |
    | 세이브 포인트 롤백 | ROLLBACK TO SAVEPOINT 이름; | SAVEPOINT로 지정한 부분 이후에 발생한 트랜잭션 취소   |
  
    - EX. 'A' 테이블에서 COMMIT과 ROLLBACK을 같이 사용하는 경우.
  
      ```SQL
      INSERT INTO A VALUES(1);
      COMMIT; /* 기존 명령어가 DB에 영구적으로 삽입 */ 
      INSERT INTO A VALUES(2);
      ROLLBACK; /* COMMIT 이후 명령어는 원상 복구 */
      -> 실행 완료 후 테이블에 1만 남아있음
      ```
  
    - EX. 'A' 테이블에서 SAVEPOINT, COMMIT, ROLLBACK을 같이 사용하는 경우
  
      ```SQL
      INSERT INTO A VALUES(1);
      SAVEPOINT SP; /* SAVEPOINT를 SP라는 이름으로 설정 */
      INSERT INTO A VALUES(2);
      ROLLBACK TO SAVEPOINT SP; /* SAVEPOINT SP 지정된 부분부터 현재 위치 사이에 실행한 명령어 원상복구 */
      INSERT INTO A VALUES(3);
      COMMIT;
      -> 실행 완료 후 테이블에 1, 3 남아있음
      ```



#### 3. 윈도 함수

