## Ch2. SQL 활용

### (1) 기본 SQL 작성

#### 1. 데이터 정의어(DDL)

**데이터 정의어(Data Definition Language)** 는 데이터를 정의하는 언어로서 데이터를 담는 그릇을 정의하는 언어이다.

- 테이블과 같은 데이터 구조를 정의하는 데 사용되는 명령어.
- 특정 구조를 생성, 변경, 삭제, 이름을 바꾸는 데이터 구조와 관련된 명령어들.



- 대상<span style="color:blue">*VV*</span>

  |    DDL 대상     | 설명                                                         |
  | :-------------: | :----------------------------------------------------------- |
  | 도메인(Domatin) | 하나의 속성이 가질 수 있는 원자값들의 집합<br />속성의 데이터 타입과 크기, 제약조건 등의 정보 |
  | 스키마(Schema)  | 데이터베이스의 구조, 제약조건 등의 정보를 담고 있는 기본적인 구조<br />1. 외부 스키마(External Schema)<br />    사용자나 개발자의 관점에서 필요로 하는 데이터베이스의 논리적 구조<br />    사용자 뷰를 나타냄, 서브 스키마라고도 불림.<br />2. 개념 스키마(Conceptual Schema)<br />    데이터베이스의 전체적인 논리적 구조<br />    전체적인 뷰를 나타냄.<br />3. 내부 스키마(Internal Schema)<br />    물리적 저장장치의 관점에서 보는 데이터베이스 구조<br />    실제로 데이터베이스에 저장될 레코드의 형식을 정의<br />    저장 데이터 항목의 표현 방법 |
  |  테이블(Table)  | 데이터 저장 공간                                             |
  |    뷰(View)     | 하나 이상의 물리 테이블에서 유도되는 가상의 테이블           |
  |  인덱스(Index)  | 검색을 빠르게 하기 위한 데이터 구조                          |

  

- 명령어 <span style="color:blue">*VVVVVVV*</span>

- | 구분 | DDL 명령어 | 설명                            |
  | :--: | :--------: | :------------------------------ |
  | 생성 |   CREATE   | 데이터베이스 오브젝트 생성      |
  | 수정 |   ALTER    | 데이터베이스 오브젝트 변경      |
  | 삭제 |    DROP    | 데이터베이스 오브젝트 삭제      |
  | 삭제 |  TRUNCATE  | 데이터베이스 오브젝트 내용 삭제 |

  - CREATE 명령어

    - 문법

      ```SQL
      CREATE TABLE 테이블명
      (
      	속성명 데이터타입 [NOT NULL], ...,
      	PRIMARY KEY(기본키),
      	UNIQUE(속성명, ...),
      	FOREIGN KEY(외래키) REFERNECES 참조테이블(기본키),
      	CONSTRAINT 제약조건명 CHECK(조건식)
      );
      ```

    - 속성

      |    속성     | 설명                                                         |
      | :---------: | :----------------------------------------------------------- |
      | PRIMARY KEY | 테이블의 기본 키를 정의<br />유일하게 테이블의 각 행을 식별  |
      | FOREIGN KEY | 외래 키를 정의<br />참조 대상을 테이블(컬럼명)로 명시        |
      |   UNIQUE    | 테이블 내에서 얻은 유일한 값을 갖도록 하는 속성              |
      |  NOT NULL   | 해당 컬럼은 NULL 값을 포함하지 않도록 하는 속성              |
      |    CHECK    | 개발자가 정의하는 제약조건<br />참(TRUE)이어야 하는 조건을 지정 |
      |   DEFAULT   | 해당 필드의 기본값을 설정                                    |

  - ALTER 명령어

    |    구분     |                             문법                             | 설명                                                         |
    | :---------: | :----------------------------------------------------------: | :----------------------------------------------------------- |
    |  컬럼 추가  |        ALTER TABLE 테이블명 ADD 컬럼명 데이터\_타입;         | 테이블에 필요한 컬럼을 추가하는 명령어                       |
    |  컬럼 수정  | ALTER TABLE 테이블명 MODIFY 컬럼명 데이터\_타입 [DEFAULT 값] [NOT NULL]; | 기존 테이블에 존재하는 컬럼의 데이터 유형, 기본값, NOT NULL등의 제약조건에 대한 변경 |
    |  컬럼 삭제  |              ALTER TABLE 테이블명 DROP 컬럼명;               | 테이블에 존재하는 컬럼을 삭제하는 명령어                     |
    | 컬럼명 수정 | ALTER TABLE 테이블명 RENAME COLUMN 변경 전\_컬럼명 TO 변경 후\_컬럼명; | 테이블의 컬럼명을 변경하는 명령어                            |

    - 예시

      ```SQL
      ALTER TABLE 사원 ADD 나이 INTEGER DEFAULT 20;
      ```

    - 속성

      CREATE TABLE의 속성에 사용되는 제약조건들을 ALTER TABLE에서도 사용할 수 있다.

  - DROP 명령어

    - 문법

      ```SQL
      DROP TABLE 테이블명 [CASCADE | RESTRICT];
      ```

    - 명령어 옵션 <span style="color:blue">*VVV*</span>

      |   옵션   | 설명                                                         |
      | :------: | :----------------------------------------------------------- |
      | CASCADE  | 참조하는 테이블까지 연쇄적으로 제거하는 옵션                 |
      | RESTRICT | 다른 테이블이 삭제할 테이블을 참조 중이면 제거하지 않는 옵션 |

  - TRUNCATE 명령어

    - 예시

      ```SQL
      TRUNCATE TABLE 테이블명;
      ```





#### 2. 관계형 데이터 모델

**관계형 데이터 모델(Relation Data Model)** 은 보편적인 데이터 모델로, 계층 모델과 망 모델의 복잡한 구조를 단순화시킨 모델이다.

- 대표적 언어로 SQL이 있다.

- 데이터 간의 관계를 기본 키와 이름 참조하는 외래 키로 표현한다.

- 테이블 간 관계를 1:1, 1:N, M:N 관계로 목적에 맞게 표현한다.

  

- 표현 예시

  ![관계형 데이터 모델](http://ehpub.co.kr/wp-content/uploads/2016/12/%EA%B4%80%EA%B3%84%ED%98%95-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%AA%A8%EB%8D%B8.png)

  - 고객 테이블, 예약 테이블, 예약서 테이블을 관계 데이터 모델로 표현.
  - 고객 테이블의 Primary Key는 번호, 예약서 테이블의 Primary Key는 예약 번호.
  - 고객 테이블과 예약 테이블은 1:N 관계, 예약 테이블과 예약서 테이블은 1:1 관계.
  - 이미지 출처 - [언제나 휴일 프로그래머 블로그 - 17. 관계 데이터 모델](https://ehpub.co.kr/17-%EA%B4%80%EA%B3%84-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%AA%A8%EB%8D%B8/)





#### 3. 트랜잭션

**트랜잭션(Transaction)** 은 데이터베이스 시스템에서 하나의 논리적 기능을 정상적으로 수행하기 위한 작업의 기본 단위이다.

- 인가받지 않은 사용자로부터 데이터를 보장하기 위해 DBMS가 가져야 하는 특성.

  

- 특징 <span style="color:blue">*VVVVVVVVVVV*</span>

  |        특징         | 설명                                                         | 주요 기법                                                    |
  | :-----------------: | :----------------------------------------------------------- | :----------------------------------------------------------- |
  |  원자성(Atomicity)  | 분해가 불가능한 작업의 최소단위<br />연산 전체가 성공 또는 실패(All or Nothing) | Commit/Rollback<br />회복성 보장                             |
  | 일관성(Consistency) | 트랜잭션이 실행 성공 후 항상 일관된 데이터베이스 상태를 보존해야 함 | 무결성 제약 조건<br />병행 제어                              |
  |  격리성(Isolation)  | 트랜잭션 실행 중 생성하는 연산의 중간 결과를 다른 트랜잭션이 접근 불가 | Read Uncommit<br />Read Commit<br />Repeatable Read<br />Serializable |
  | 영속성(Durability)  | 성공이 완료된 트랜잭션의 결과는 영속적으로 데이터베이스에 저장 | 회복 기법                                                    |

  

- 트랜잭션 연산

  - 트랜잭션 연산(원자성 주요 기법) <span style="color:blue">*V*</span>

    |      연산      | 설명                                                         |
    | :------------: | :----------------------------------------------------------- |
    |  커밋(Commit)  | 하나의 트랜잭션이 성공적으로 끝나고, 데이터베이스가 일관성 있는 상태에서 있거나 하나의 트랜잭션이 끝났을 때 사용하는 연산 |
    | 롤백(Rollback) | 하나의 트랜잭션이 비정상적으로 종료되어 트랜잭션 원자성이 깨질 경우 처음부터 다시 시작하거나, 부분적으로 연산을 취소하는 연산 |

  - 병행 제어(일관성 주요 기법)

    **병행 제어(Concurrency Control)** 는 다수 사용자 환경에서 여러 트랜잭션을 수행할 때, 데이터베이스 일관성 유지를 위해 상호작용을 제어하는 기법이다.

    - 목적 <span style="color:blue">*VVV*</span>

      - 데이터베이스의 공유 최대화.
      - 시스템의 활용도 최대화.
      - 데이터베이스의 일관성 유지.
      - 사용자에 대한 응답시간 최소화.

    - 미보장 시 문제점

      |            문제점            | 설명                                                         |
      | :--------------------------: | :----------------------------------------------------------- |
      |    갱신 손실(Lost Update)    | 먼저 실행된 트랜잭션의 결과를 나중에 실행된 트랜잭션이 덮어쓸 때 발생하는 오류 |
      |  현황 파악오류(Dirty Read)   | 트랜잭션의 중간 수행 결과를 다른 트랜잭션이 참조하여 발생하는 오류 |
      |    모순성(Inconsistency)     | 두 트랜잭션이 동시에 실행되어 데이터베이스의 일관성이 결여되는 오류 |
      | 연쇄복귀(Cascading Rollback) | 복수의 트랜잭션이 데이터 공유 시 특정 트랜잭션이 처리를 취소할 경우<br />트랜잭션이 처리한 곳의 부분을 취소하지 못하는 오류 |

    - 종류 <span style="color:blue">*VV*</span>

      |                             기법                             | 설명                                                         |
      | :----------------------------------------------------------: | :----------------------------------------------------------- |
      |     로킹(Locking) <span style="color:blue">*VVV*</span>      | 같은 자원을 액세스 하는 다중 트랜잭션 환경에서 DB의 일관성과 무결성을 유지하기 위해 트랜잭션의 순차적 진행을 보장하는 직렬화 기법<br />특징<br />    데이터베이스, 파일, 레코드 등은 로킹 단위가 될 수 있음<br />    로킹 단위가 작아지면 데이터베이스 공유도 증가, 로킹 오버헤드 증가<br />    한꺼번에 로킹할 수 있는 객체의 크기를 로킹 단위라고 함 |
      |                         낙관적 검증                          | 트랜잭션이 어떠한 검증도 수행하지 않고 일단 트랜잭션을 수행하고, 트랜잭션 종료 시 검증을 수행하여 데이터베이스에 반영하는 기법 |
      |         타임 스탬프 순서<br />(Time Stamp Ordering)          | 트랜잭션과 트랜잭션이 읽거나 갱신한 데이터에 대해 트랜잭션이 실행을 시작하기 전에 타임 스탬프를 부여하여 부여된 시간에 따라 트랜잭션 작업을 수행하는 기법 |
      | 다중버전 동시성 제어<br />(MVCC; Multi Version Concurrency Control) | 트랜잭션의 타임스탬프와 접근하려는 데이터의 타임스탬프를 비교하여 직렬가능성이 보장되는 적절한 버전을 선택하여 접근하도록 하는 기법 |

  - 데이터베이스 고립화 수준(격리성 주요 기법)

    **고립화 수준(Isolation Level)** 은 다음 트랜잭션이 현재의 데이터에 대한 무결성을 해치지 않기 위해 잠금을 설정하는 정도이다.

    - 종류

      |       수준        | 설명                                                         |
      | :---------------: | :----------------------------------------------------------- |
      | Read Uncommitted  | 한 트랜잭션에서 연산 중인 데이터를 다른 트랜잭션이 읽는 것을 허용하는 수준<br />연산 중인 데이터에 대한 연산은 불허 |
      |  Read Committed   | 한 트랜잭션에서 연산을 수행할 때, 연산이 완료될 때까지 연산 대상 데이터에 대한 읽기를 제한하는 수준<br />연산이 완료되어 커밋된 데이터는 다른 트랜잭션이 읽는 것을 허용 |
      |  Repeatable Read  | 선행 트랜잭션이 특정 데이터를 읽을 때, 트랜잭션 종료 시까지 해당 데이터에 대한 갱신/삭제를 제한하는 수준 |
      | Serializable Read | 선행 트랜잭션이 특정 데이터 영역을 순차적으로 읽을 때, 해당 데이터 영역 전체에 대한 접근을 제한하는 수준 |

  - 회복 기법(영속성 주요 기법)

    **회복 기법(Recovery)** 은 트랜잭션을 수행하는 도중 장애로 인해 손상된 데이터베이스를 손상되기 이전의 정상적인 상태로 복구시키는 작업이다.

    - 종류 <span style="color:blue">*VV*</span>

      |                      기법                       | 설명                                                         |
      | :---------------------------------------------: | :----------------------------------------------------------- |
      |               로그 기반 회복 기법               | 자연 갱신 회복 기법(Deferred Update): 트랜잭션이 완료되기 전까지 데이터베이스에 기록하지 않는 기법<br />즉각 갱신 회복 기법(Immediate Update): 트랜잭션 수행 중 갱신 결과를 바로 DB에 반영하지 않는 기법 |
      |   체크 포인트 회복 기법(Checkpoint Recovery)    | 장애 발생 시 검사점 이후에 처리된 트랜잭션에 대해서만 장애 발생 이전의 상태로 복원시키는 회복 기법 |
      | 그림자 페이징 회복 기법(Shadow Paging Recovery) | 데이터베이스 트랜잭션 수행 시 복제본을 생성하여 데이터베이스 장애 시 이를 이용해 복구하는 기법 |

  

- 트랜잭션 상태 변화

  |               상태                | 설명                                                         |
  | :-------------------------------: | :----------------------------------------------------------- |
  |         활동 상태(Active)         | 초기 상태, 트랜잭션이 실행 중일 때 가지는 상태               |
  | 부분완료 상태(Partially Commited) | 마지막 명령문이 실행된 후에 가지는 상태                      |
  |       완료 상태(Committed)        | 트랜잭션이 성공적으로 완료된 후 가지는 상태                  |
  |         실패 상태(Failed)         | 정상적인 실행이 더 이상 진행될 수 없을 때 가지는 상태        |
  |        철회 상태(Aborted)         | 트랜잭션이 취소되고 데이터베이스가 트랜잭션 시작 전 상태로 환원된 상태 |

  

- 트랜잭션 제어(TCL) <span style="color:blue">*VV*</span>

  **트랜잭션 제어(Transaction Control Language)** 는 트랜잭션의 결과를 허용하거나 취소하는 목적으로 사용되는 언어이다.

  |         명령어         | 핵심           | 설명                                |
  | :--------------------: | :------------- | :---------------------------------- |
  |      커밋(COMMIT)      | 트랜잭션 확정  | 트랜잭션을 메모리에 영구적으로 저장 |
  |     롤백(ROLLBACK)     | 트랜잭션 취소  | 트랜잭션 내역을 저장 무효화시킴     |
  | 체크포인트(CHECKPOINT) | 저장 시기 설정 | ROLLBACK을 위한 시점을 지정         |





#### 4. 테이블

**테이블(Table)** 은 데이터를 저장하는 항목인 필드들로 구성된 데이터의 집합체이다.

- 하나의 DB 내에 여러 개의 테이블들로 구성될 수 있다.
- 릴레이션(Relation) 혹은 엔터티(Entity)라고도 불린다.



- 테이블의 구성 조건
  1. 테이블에 포함된 행들은 유일해야하고 중복된 행이 존재하지 않아야 한다.
  2. 테이블에 포함된 행들 간에는 순서가 존재하지 않는다.
  3. 테이블을 구성하는 열들 간에는 순서가 존재하지 않는다.



- 구조

  컬럼 < 테이블 < 데이터베이스



- 용어 <span style="color:blue">*VVV*</span>

  |                용어                | 설명                                                         |
  | :--------------------------------: | :----------------------------------------------------------- |
  |       튜플(Tuple) / 행(Row)        | 테이블 내의 행을 의미하며 레코드(Record)라고도 함<br />튜플은 릴레이션(Relation)에서 같은 값을 가질 수 없음 |
  | 애트리뷰트(Attribute) / 열(Column) | 테이블 내의 열을 의미                                        |
  |         식별자(identifier)         | 여러 개의 집합체를 담고 있는 관계형 데이터베이스에서 각각의 구분을 할 수 있는 논리적인 개념 |
  |      카디널리티(Cardinality)       | 튜플의 개수<br />튜플의 최대 개수 = 각 속성의 모든 도메인값의 곱 |
  |            차수(Degree)            | 애트리뷰트의 개수                                            |
  |           도메인(Domain)           | 하나의 애트리뷰트가 취할 수 있는 같은 타입의 원자값들의 집합 |





#### 5. 데이터 사전

**데이터 사전(Data Dictionary)** 은 데이터베이스에 저장되는 테이블, 뷰, 인덱스, 접근 권한 등에 대한 정보를 저장하는 데이터베이스이다.

- 데이터 사전의 내용을 변경하는 권한은 시스템이 가진다. 사용자에게는 읽기 전용 테이블 형태로 제공된다.
- 데이터 사전은 데이터에 대한 데이터를 의미하는 메타데이터(Metadata)로 구성된다.



- 데이터 사전 내용(DBMS 공통)

  - 사용자 정보(아이디, 패스워드, 성별 등)
  - 데이터베이스 객체 정보(테이블, 뷰, 인덱스 등)
  - 무결성 제약 정보(Constraints)
  - 함수, 프로시저 및 트리거

  

- 데이터 사전 검색

  - Oracle 데이터 사전 검색

    - Oracle 사용자는 뷰로 데이터 사전에 접근할 수 있다.

    - Oracle에서 데이터 사전과 관련된 뷰는 DBA\_, ALL\_, USER\_이 있다. 

    - 우선순위:  DBA\_ \> ALL\_ \> USER\_

      | 명령어 | 설명                                                         |
      | :----: | :----------------------------------------------------------- |
      | DBA\_  | 데이터베이스의 모든 객체 조회 가능                           |
      | ALL\_  | 자신의 계정으로 접근 가능한 객체와 타계정의 접근 권한을 가진 모든 객체 조회 가능 |
      | USER\_ | 현재 자신의 계정이 소유한 객체 조회가능                      |

  - MySQL 데이터 사전 검색

    - 데이터 사전은 테이블 형태로 구성되어 있다.
    - MySQL에서 데이터 사전은 information\_schema라는 데이터베이스 안에 존재한다.







### (2) 고급 SQL 작성

